<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>Карта доступности улчино-дорожной сети в городе Уфа (изохроны)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
<link
href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css"
rel="stylesheet"
/>
<link
href="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.min.css"
rel="stylesheet"
/>
<script src="https://api.mapbox.com/mapbox-assembly/v1.3.0/assembly.js"></script>
<style>
body {
margin: 0;
padding: 0;
}

#map {
position: absolute;
top: 0;
bottom: 0;
width: 100%;
}

.popup {
  position: absolute;
  top: 20px; /* Adjust the distance from the top */
  right: 20px; /* Position to the right upper corner */
  padding: 10px;
  background-color: rgba(255, 255, 255, 0.9); /* White opacity background */
  border: 1px solid #000; /* Black outline */
  border-radius: 10px; /* Rounded corners */
  font-size: 14px;
}

.popup a {
  color: '#2983FF'; /* Link color */
}


</style>
</head>
 
<body>

    <div id="map"></div>

    <div class="absolute fl my24 mx24 py24 px24 bg-gray-faint round" style="border: 1px solid #9F9F9F;">
      <form id="params">
        <h4 class="txt-m txt-bold mb6">Выберите тип изохрон:</h4>
        <div class="mb12 mr12 toggle-group align-center">
          <label class="toggle-container">
            <input name="profile" type="radio" value="walking" />
            <div class="toggle toggle--active-null toggle--null">Пешком</div>
          </label>
          <label class="toggle-container">
            <input name="profile" type="radio" value="cycling" checked />
            <div class="toggle toggle--active-null toggle--null">Велосипед</div>
          </label>
          <label class="toggle-container">
            <input name="profile" type="radio" value="driving" />
            <div class="toggle toggle--active-null toggle--null">Автомобиль</div>
          </label>
        </div>
        <h4 class="txt-m txt-bold mb6">Выберите время движения:</h4>
        <div class="mb12 mr12 toggle-group align-center">
          <label class="toggle-container">
            <input name="duration" type="radio" value="10" checked />
            <div class="toggle toggle--active-null toggle--null">10 мин</div>
          </label>
          <label class="toggle-container">
            <input name="duration" type="radio" value="20" />
            <div class="toggle toggle--active-null toggle--null">20 мин</div>
          </label>
          <label class="toggle-container">
            <input name="duration" type="radio" value="30" />
            <div class="toggle toggle--active-null toggle--null">30 мин</div>
          </label>
        </div>
      </form>
    </div>
    
    <div class="popup">
  <p>О чём эта карта?<a href="https://mapufa.ru/about-karst-map"> Узнать</a></p>
</div>

<script>
    
    mapboxgl.accessToken = 'pk.eyJ1IjoiYXphdHNhIiwiYSI6ImNrbWl3dGhxNTBscjcydms1MTloMWl3OTMifQ.qz7WJvUSNZhNL4Co7sL_UA';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v10',
  center: [55.96139909745693,54.73170947397054],
  zoom: 12
});

let marker = new mapboxgl.Marker();

function addMarker(event) {
  const coordinates = event.lngLat;
  console.log('Lng:', coordinates.lng, 'Lat:', coordinates.lat);
  marker.setLngLat(coordinates).addTo(map);
  lon = coordinates.lng;
  lat = coordinates.lat;
  getIso();
}

map.on('click', addMarker);

const params = document.getElementById('params');
const urlBase = 'https://api.mapbox.com/isochrone/v1/mapbox/';
let lon = -77.034;
let lat = 38.899;
let profile = 'cycling';
let minutes = 10;

async function getIso() {
  const query = await fetch(
    `${urlBase}${profile}/${lon},${lat}?contours_minutes=${minutes}&polygons=true&access_token=${mapboxgl.accessToken}`,
    { method: 'GET' }
  );
  const data = await query.json();
  map.getSource('iso').setData(data);
}

params.addEventListener('change', (event) => {
  if (event.target.name === 'profile') {
    profile = event.target.value;
  } else if (event.target.name === 'duration') {
    minutes = event.target.value;
  }
  getIso();
});

map.on('load', () => {
  map.addSource('iso', {
    type: 'geojson',
    data: {
      type: 'FeatureCollection',
      features: []
    }
  });

  map.addLayer(
    {
      id: 'isoLayer',
      type: 'fill',
      source: 'iso',
      layout: {},
      paint: {
        'fill-color': '#6F97CF',
        'fill-opacity': 0.3,
        'fill-outline-color': '#0E3C7C', // Add outline color
        'fill-outline-width': 2 // Add outline width
      }
    },
    'poi-label');
    
  map.addSource('bus_stops', {
    type: 'geojson',
    data: 'https://raw.githubusercontent.com/AzatSkyArchLab/ufa_karst_map_data/main/all_bus_stop.geojson'
  });

  // Add a layer for the bus stop points
  map.addLayer({
    id: 'bus_stop_points',
    type: 'circle',
    source: 'bus_stops',
    paint: {
      'circle-radius': 3,
      'circle-color': '#5F8DCD'
    }
  });
  
    map.addLayer({
    id: 'bus_stop_labels',
    type: 'symbol',
    source: 'bus_stops',
    layout: {
      'text-field': ['get', 'name'], // Display the 'name' attribute as text
      'text-size': 10, // Font size of the text
      'text-offset': [0, 2], // Offset the text above the point
      'text-anchor': 'top' // Anchor the text to the top of the point
    },
    paint: {
      'text-color': '#545454' // Set the color of the text
    }
  });
        

  // Set the initial coordinates for the marker
  const initialCoordinates = [55.96139909745693,54.73170947397054]; // Example coordinates
  marker.setLngLat(initialCoordinates).addTo(map);
  lon = initialCoordinates[0];
  lat = initialCoordinates[1];
  getIso();
});

function addMarker(event) {
  const coordinates = event.lngLat;
  console.log('Lng:', coordinates.lng, 'Lat:', coordinates.lat);
  marker.setLngLat(coordinates).addTo(map);  // Update the marker position on click
  lon = coordinates.lng;
  lat = coordinates.lat;
  getIso();
}

map.on('click', addMarker);

</script>

</body>
</html>
